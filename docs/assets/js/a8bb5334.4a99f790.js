"use strict";(self.webpackChunkguide_github_action_renovate=self.webpackChunkguide_github_action_renovate||[]).push([[756],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var u=a.createContext({}),s=function(e){var t=a.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=s(e.components);return a.createElement(u.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,u=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=s(n),h=o,m=d["".concat(u,".").concat(h)]||d[h]||c[h]||r;return n?a.createElement(m,l(l({ref:t},p),{},{components:n})):a.createElement(m,l({ref:t},p))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,l=new Array(r);l[0]=h;var i={};for(var u in t)hasOwnProperty.call(t,u)&&(i[u]=t[u]);i.originalType=e,i[d]="string"==typeof e?e:o,l[1]=i;for(var s=2;s<r;s++)l[s]=n[s];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},3009:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>l,default:()=>c,frontMatter:()=>r,metadata:()=>i,toc:()=>s});var a=n(7462),o=(n(7294),n(3905));const r={sidebar_position:200},l="Guide",i={unversionedId:"guide",id:"guide",title:"Guide",description:"Create a GitHub branch protection rule of the default branch",source:"@site/docs/guide.md",sourceDirName:".",slug:"/guide",permalink:"/guide-github-action-renovate/guide",draft:!1,editUrl:"https://github.com/suzuki-shunsuke/guide-github-action-renovate/edit/main/docs/guide.md",tags:[],version:"current",sidebarPosition:200,frontMatter:{sidebar_position:200},sidebar:"tutorialSidebar",previous:{title:"Guide of GitHub Actions and Renovate",permalink:"/guide-github-action-renovate/"},next:{title:"Settings for Personal Project",permalink:"/guide-github-action-renovate/settings-personal-project"}},u={},s=[{value:"Create a GitHub branch protection rule of the default branch",id:"create-a-github-branch-protection-rule-of-the-default-branch",level:2},{value:"Create a GitHub Actions&#39; dedicated job for status check",id:"create-a-github-actions-dedicated-job-for-status-check",level:2},{value:"Merge GitHub Actions workflows for <code>pull_request</code> event to one workfklow for status check",id:"merge-github-actions-workflows-for-pull_request-event-to-one-workfklow-for-status-check",level:2},{value:"Update dependencies continuously by Renovate",id:"update-dependencies-continuously-by-renovate",level:2},{value:"Merge pull requests automatically",id:"merge-pull-requests-automatically",level:2},{value:"Exclude risky updates from auto-merge",id:"exclude-risky-updates-from-auto-merge",level:2},{value:"Spread the target of auto-merge gradually",id:"spread-the-target-of-auto-merge-gradually",level:2},{value:"Test dependency updates by CI",id:"test-dependency-updates-by-ci",level:2},{value:"Use GitHub auto-merge feature",id:"use-github-auto-merge-feature",level:2},{value:"Enable auto-merge by GitHub Actions",id:"enable-auto-merge-by-github-actions",level:2},{value:"For team development",id:"for-team-development",level:2},{value:"Configure a branch protection rule of the default branch to enforce the review",id:"configure-a-branch-protection-rule-of-the-default-branch-to-enforce-the-review",level:3},{value:"Configure a branch protection rule of Renovate branches to forbid to add changes without the review",id:"configure-a-branch-protection-rule-of-renovate-branches-to-forbid-to-add-changes-without-the-review",level:3},{value:"Create a dedicated GitHub App to push commits to a Renovate pull request",id:"create-a-dedicated-github-app-to-push-commits-to-a-renovate-pull-request",level:3},{value:"(Optional) Update branch of Renovate pull request by comment",id:"optional-update-branch-of-renovate-pull-request-by-comment",level:3},{value:"\ud83d\udca1 Consider self-hosted runner to save money",id:"-consider-self-hosted-runner-to-save-money",level:3},{value:"For public repository",id:"for-public-repository",level:2},{value:"Support pull requests from fork repositories",id:"support-pull-requests-from-fork-repositories",level:3}],p={toc:s},d="wrapper";function c(e){let{components:t,...n}=e;return(0,o.kt)(d,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"guide"},"Guide"),(0,o.kt)("h2",{id:"create-a-github-branch-protection-rule-of-the-default-branch"},"Create a GitHub branch protection rule of the default branch"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/defining-the-mergeability-of-pull-requests/managing-a-branch-protection-rule"},"Managing a branch protection rule"))),(0,o.kt)("p",null,"You should protect the default branch by GitHub branch protection rule.\nAt least, the following settings should be enabled."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Require a pull request before merging")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Require status checks to pass before merging"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Status checks that are required."),": ",(0,o.kt)("inlineCode",{parentName:"li"},"status-check"))))),(0,o.kt)("p",null,"The meaning of these settings is simple, ",(0,o.kt)("strong",{parentName:"p"},"changes of the default branch must be tested"),"."),(0,o.kt)("h2",{id:"create-a-github-actions-dedicated-job-for-status-check"},"Create a GitHub Actions' dedicated job for status check"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Status checks that are required.")," is an essential setting.\nYou can't merge a pull request whose ",(0,o.kt)("inlineCode",{parentName:"p"},"required jobs")," fail,\nbut in other words you can merge a pull request even if jobs other than ",(0,o.kt)("inlineCode",{parentName:"p"},"required jobs")," fail. This is undesirable."),(0,o.kt)("p",null,"If you add jobs to ",(0,o.kt)("inlineCode",{parentName:"p"},"Status checks that are required."),", it is inconvenient when you add a new job to the workflow and ",(0,o.kt)("inlineCode",{parentName:"p"},"Status checks that are required.")," or change job names because until you merge a pull request to add a new job to the workflow you can't merge other pull requests."),(0,o.kt)("p",null,"Futhermore, if you don't have the permission to change GitHub Repository Settings and you have to ask someone to change them, it would be inconvenient."),(0,o.kt)("p",null,"So you should define a dedicated job and adding only the job to ",(0,o.kt)("inlineCode",{parentName:"p"},"Status checks that are required."),".\nWe call this job ",(0,o.kt)("inlineCode",{parentName:"p"},"status-check")," job."),(0,o.kt)("p",null,"e.g."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"  status-check:\n    # This job is used for main branch's branch protection rule's status check.\n    # If all dependent jobs succeed or are skipped this job succeeds.\n    runs-on: ubuntu-latest\n    needs:\n      - update-aqua-checksums\n      - test\n      - build\n      - renovate-config-validator\n      - ghalint\n    permissions: {}\n    if: failure()\n    steps:\n      - run: exit 1\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"You can't merge ",(0,o.kt)("inlineCode",{parentName:"p"},"status-check")," job and a job to enable auto-merge and approve a pull request."),(0,o.kt)("details",null,(0,o.kt)("summary",null,"Example"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"  status-check:\n    runs-on: ubuntu-latest\n    needs:\n      - update-aqua-checksums\n      - test\n      - renovate-config-validator\n    permissions: {}\n    if: |\n      ! failure() && ! cancelled() && github.event.pull_request.user.login == 'renovate[bot]' && contains(github.event.pull_request.body, ' **Automerge**: Enabled.')\n    steps:\n      - name: Generate token\n        id: generate_token\n        uses: tibdex/github-app-token@021a2405c7f990db57f5eae5397423dcc554159c # v1\n        with:\n          app_id: ${{secrets.gh_app_id}}\n          private_key: ${{secrets.gh_app_private_key}}\n      - run: gh -R \"$GITHUB_REPOSITORY\" pr merge --merge --auto --delete-branch \"$PR_NUMBER\"\n        env:\n          GITHUB_TOKEN: ${{steps.generate_token.outputs.token}} # Use GitHub App to trigger GitHub Actions Workflow by merge commit.\n          PR_NUMBER: ${{github.event.pull_request.number}}\n      # ...\n"))),(0,o.kt)("p",{parentName:"admonition"},"The issue of this example is that ",(0,o.kt)("inlineCode",{parentName:"p"},"status-check")," is skipped when some of needs jobs fails so you can merge the pull request unexpectedly.")),(0,o.kt)("h2",{id:"merge-github-actions-workflows-for-pull_request-event-to-one-workfklow-for-status-check"},"Merge GitHub Actions workflows for ",(0,o.kt)("inlineCode",{parentName:"h2"},"pull_request")," event to one workfklow for status check"),(0,o.kt)("p",null,"If a workflow is run only when specific files are changed, you can't add the workflow's jobs to ",(0,o.kt)("inlineCode",{parentName:"p"},"Status checks that are required."),", so even if the workflow fails you can merge a pull request. This is undesirable."),(0,o.kt)("p",null,"To solve the issue, you should merge workflows for ",(0,o.kt)("inlineCode",{parentName:"p"},"pull_request")," event to one workflow which is always triggered and add jobs to ",(0,o.kt)("inlineCode",{parentName:"p"},"status-check")," job's ",(0,o.kt)("inlineCode",{parentName:"p"},"needes"),". We call this workflow ",(0,o.kt)("inlineCode",{parentName:"p"},"one workflow"),". And to run jobs only when specific files are changed, you should use ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/dorny/paths-filter"},"dorny/paths-filter")," or similar action."),(0,o.kt)("p",null,"e.g."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"  path-filter:\n    outputs:\n      renovate-config-validator: ${{steps.changes.outputs.renovate-config-validator}}\n    runs-on: ubuntu-latest\n    steps:\n      - uses: dorny/paths-filter@v2\n        id: changes\n        with:\n          filters: |\n            renovate-config-validator:\n              - renovate.json5\n\n  renovate-config-validator:\n    uses: suzuki-shunsuke/renovate-config-validator-workflow/.github/workflows/validate.yaml@v0.2.0\n    needs: path-filter\n    if: needs.path-filter.outputs.renovate-config-validator == 'true'\n")),(0,o.kt)("p",null,"There are an exception of ",(0,o.kt)("inlineCode",{parentName:"p"},"one workflow"),"."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"actionlint"),": A workflow to run ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/rhysd/actionlint"},"actionlint"))),(0,o.kt)("p",null,"actionlint should be run in a dedicated workflow because if the workflow gets invalid actionlint isn't run and you can't find the issue."),(0,o.kt)("p",null,"If you want to trigger the workflow by not only ",(0,o.kt)("inlineCode",{parentName:"p"},"pull_request")," event but also other events, please change the workflow to a Reusable Workflow and share the workflow with multiple workflows."),(0,o.kt)("h2",{id:"update-dependencies-continuously-by-renovate"},"Update dependencies continuously by Renovate"),(0,o.kt)("p",null,"It is important to keep dependencies up-to-date.\nIf you don't update dependencies continuously, you would face the following issues."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"You can't take any support from maintainers"),(0,o.kt)("li",{parentName:"ul"},"You can't use new features"),(0,o.kt)("li",{parentName:"ul"},"The behaviour of a old tool is different from the latest document"),(0,o.kt)("li",{parentName:"ul"},"If you do a big update including a lot of changes, it is hard to check Release Notes, verify the update, solve the upgrading issues, and detect the root cause when any problem occurs after upgrading"),(0,o.kt)("li",{parentName:"ul"},"The frequency of big updates is lower than the frequency of continuous updates, so it is difficult to keep the knowledge and improve the procedure")),(0,o.kt)("p",null,"On the other hand, if you keep dependencies up-to-date, you can solve the above issues.\nRenovate enables the continuous updates."),(0,o.kt)("p",null,"Renovate is awesome and can be introduced easily, but it isn't enough to just install Renovate.\nTo utilize Renovate fully, you should not only tune Renovate settings but also configure GitHub Repository settings properly and tune GitHub Actions Workflows in accordance with Renovate."),(0,o.kt)("h2",{id:"merge-pull-requests-automatically"},"Merge pull requests automatically"),(0,o.kt)("p",null,"Renovate would create many pull requests every day.\nIt would be hard to review and merge all of them manually.\nYou would be exhausted and frustrated, and finally pull requests would tend to be left."),(0,o.kt)("p",null,"To solve the problem, you should merge pull requests from Renovate automatically.\nThe burden of handling pull requests from Renovate would decrease and you would be able to focus on more essential tasks."),(0,o.kt)("h2",{id:"exclude-risky-updates-from-auto-merge"},"Exclude risky updates from auto-merge"),(0,o.kt)("p",null,"Some updates should not be merged automatically.\nFor example, normally major updates should not be merged automatically (If you know the major update is safe, you would be able merge pull requests automatically).\nRenovate can enable or disable the auto-merge flexibly."),(0,o.kt)("h2",{id:"spread-the-target-of-auto-merge-gradually"},"Spread the target of auto-merge gradually"),(0,o.kt)("p",null,"If you hesitate to enable auto-merge, you can also enable auto-merge against only specific packages.\nAfter that, you would understand the benefit of auto-merge and would like to merge more pull requests automatically.\nThen you can spread the target of auto-merge gradually."),(0,o.kt)("h2",{id:"test-dependency-updates-by-ci"},"Test dependency updates by CI"),(0,o.kt)("p",null,"Depency updates should be tested by CI.\nOtherwise, you would miss bugs.\nProbably you already test updates your application depends on directly, but maybe you don't test other updates."),(0,o.kt)("p",null,"For example, when a tool for document generation is updated, the tool should be run in CI, and the document should be updated automatically or CI should fail if the document is changed."),(0,o.kt)("p",null,"Automerge consists of CI's reliability. It is mandatory to test dependency updates by CI in order to enable auto-merge."),(0,o.kt)("h2",{id:"use-github-auto-merge-feature"},"Use GitHub auto-merge feature"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/automatically-merging-a-pull-request"},"Automatically merging a pull request"))),(0,o.kt)("p",null,"To merge a pull request safely, you should enable GitHub auto-merge.\nTo use this feature, you have to configure the branch protection rule described above.\nRenovate supports the auto-merge, but using GitHub native auto-merge feature you can merge pull requests more quickly."),(0,o.kt)("h2",{id:"enable-auto-merge-by-github-actions"},"Enable auto-merge by GitHub Actions"),(0,o.kt)("p",null,"Renovate supports ",(0,o.kt)("a",{parentName:"p",href:"https://docs.renovatebot.com/configuration-options/#platformautomerge"},"platformAutomerge")," enabling GitHub ",(0,o.kt)("inlineCode",{parentName:"p"},"auto-merge")," automatically, but there are some issues."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"platformAutomerge")," works only when the pull request is initially created"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"platformAutomerge")," enables auto-merge regardless the result of GitHub Actions Workflows")),(0,o.kt)("p",null,"So you should enable auto-merge by GitHub Actions without platformAutomerge."),(0,o.kt)("p",null,"You should use GitHub App rather than ",(0,o.kt)("inlineCode",{parentName:"p"},"GITHUB_TOKEN")," to enable auto-merge, because ",(0,o.kt)("inlineCode",{parentName:"p"},"GITHUB_TOKEN")," doesn't trigger GitHub Actions Workflows."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/security-guides/automatic-token-authentication#using-the-github_token-in-a-workflow"},"https://docs.github.com/en/actions/security-guides/automatic-token-authentication#using-the-github_token-in-a-workflow")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"When you use the repository's GITHUB_TOKEN to perform tasks, events triggered by the GITHUB_TOKEN, with the exception of workflow_dispatch and repository_dispatch, will not create a new workflow run.")),(0,o.kt)("p",null,"Please see ",(0,o.kt)("a",{parentName:"p",href:"#enable-github-auto-merge-in-renovate-workflow"},"Enable GitHub auto-merge in renovate workflow")," too."),(0,o.kt)("h2",{id:"for-team-development"},"For team development"),(0,o.kt)("p",null,"If you maintain a repository with other team members, which means multiple developers have the write permission, some additional settings are required."),(0,o.kt)("h3",{id:"configure-a-branch-protection-rule-of-the-default-branch-to-enforce-the-review"},"Configure a branch protection rule of the default branch to enforce the review"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Require a pull request before merging"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Require approvals")," (1 approval)"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Dismiss stale pull request approvals when new commits are pushed")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Require review from Code Owners")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Require approval of the most recent reviewable push"))))),(0,o.kt)("p",null,"This settings means ",(0,o.kt)("strong",{parentName:"p"},"a pull request must be reviewed by at least one Code Owner"),"."),(0,o.kt)("h3",{id:"configure-a-branch-protection-rule-of-renovate-branches-to-forbid-to-add-changes-without-the-review"},"Configure a branch protection rule of Renovate branches to forbid to add changes without the review"),(0,o.kt)("p",null,"You should create a branch protection rule of Renovate's branches ",(0,o.kt)("inlineCode",{parentName:"p"},"renovate/*"),"."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"renovate/*"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Do not allow bypassing the above settings")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Restrict who can push to matching branches"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Restrict pushes that create matching branches"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"renovate")),(0,o.kt)("li",{parentName:"ul"},"Dedicated GitHub App"))))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Allow deletions"),": To allow Renovate to delete branches"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Allow force pushes"),": To allow Renovate to rebase branches",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Specify who can force push"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"renovate"))))))))),(0,o.kt)("p",null,"You should forbid developers to push a commit to Renovate branches.\nOtherwise, developers can push malicious code to a pull request of Renovate and can approve and merge the pull request.\nEven if ",(0,o.kt)("inlineCode",{parentName:"p"},"Require approval of the most recent reviewable push")," is enabled, developers still can push malicious code."),(0,o.kt)("p",null,"If you want to add changes to a Renovate pull request, you should create a new pull request. You may feel bothersome, but you have no choice."),(0,o.kt)("h3",{id:"create-a-dedicated-github-app-to-push-commits-to-a-renovate-pull-request"},"Create a dedicated GitHub App to push commits to a Renovate pull request"),(0,o.kt)("p",null,"Sometimes you would like to push a commit to a Renovate pull request automatically.\nFor example, you would like to update a autogenerated document.\nIn that case, you should create a dedicated GitHub App for it.\nThe GitHub App must be dedicated and be able to be used only in the workflow triggered by a pull request from Renovate.\nOtherwise, developers can push a malicious code to a Renovate pull request using the GitHub App."),(0,o.kt)("p",null,"GitHub App's private key must be managed with ",(0,o.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment"},"GitHub Environment's Deployment branches and Environment secrets"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'  approve-and-enable-automerge-renovate:\n    runs-on: ubuntu-latest\n    environment: renovate\n    if: |\n      github.event.pull_request.user.login == \'renovate[bot]\' && contains(github.event.pull_request.body, \' **Automerge**: Enabled.\')\n    steps:\n      - name: Generate token\n        id: generate_token\n        uses: tibdex/github-app-token@021a2405c7f990db57f5eae5397423dcc554159c # v1\n        with:\n          app_id: ${{secrets.APP_ID}}\n          private_key: ${{secrets.APP_PRIVATE_KEY}}\n      - name: Enable auto-merge\n        run: gh -R "$GITHUB_REPOSITORY" pr merge --merge --auto --delete-branch "$PR_NUMBER"\n        env:\n          # github.token is unavailable, because github.token doesn\'t have a permission to delete a branch `renovate/*`\n          GITHUB_TOKEN: ${{steps.generate_token.outputs.token}}\n          PR_NUMBER: ${{github.event.pull_request.number}}\n      # https://github.com/cli/cli/issues/6680\n      # HTTP 401: Personal access tokens with fine grained access do not support the GraphQL API (https://api.github.com/graphql)\n      # - run: gh -R aquaproj/example-update-checksum pr review -a "$PR_NUMBER"\n      - name: Approve a pull request\n        run: |\n          gh api \\\n            --method POST \\\n            -H "Accept: application/vnd.github+json" \\\n            "/repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/reviews" \\\n            -f event=\'APPROVE\'\n        env:\n          PR_NUMBER: ${{github.event.pull_request.number}}\n          GITHUB_TOKEN: ${{secrets.GH_TOKEN_APPROVE_RENOVATE_PR}}\n')),(0,o.kt)("h3",{id:"optional-update-branch-of-renovate-pull-request-by-comment"},"(Optional) Update branch of Renovate pull request by comment"),(0,o.kt)("p",null,"Developers can't update branch of Renovate pull requests due to the branch protection rule.\nRenovate supports rebasing branch but sometimes you would like to update branch.\nYou can update branch of Renovate pull request by adding a GitHub Actions Workflow.\nThis workflow is triggered by pull request comment and updates branch by GitHub API."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/aquaproj/example-update-checksum/blob/main/.github/workflows/update-branch.yaml"},"example workflow")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/13323303/220363572-3d56aedf-7a09-44b8-bb34-e946f74e5b7b.png",alt:"image"})),(0,o.kt)("p",null,"We call this workflow ",(0,o.kt)("inlineCode",{parentName:"p"},"update-branch workflow"),".\nThis workflow is optional because Renovate supports rebasing branch."),(0,o.kt)("p",null,"To use this workflow, you must allow the default branch to access GitHub App Private Key to push commits to Renovate branch because ",(0,o.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#issue_comment"},"issue_comment event")," is triggered at the default branch."),(0,o.kt)("h3",{id:"-consider-self-hosted-runner-to-save-money"},"\ud83d\udca1 Consider self-hosted runner to save money"),(0,o.kt)("p",null,"As we mentioned above, you have to run some additional jobs."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"status-check")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"path-filter")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"approve-and-enable-automerge-renovate"))),(0,o.kt)("p",null,"But maybe you don't want to run these jobs to save the billing for GitHub Actions."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions"},"https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions")),(0,o.kt)("p",null,"In that case, you should consider ",(0,o.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/hosting-your-own-runners/about-self-hosted-runners"},"self-hosted runner")," because GitHub Actions usage is free for self-hosted runner."),(0,o.kt)("h2",{id:"for-public-repository"},"For public repository"),(0,o.kt)("p",null,"If you maintain a repository yourself and only you have a write permission, the following things are unnecessary."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"a personal access token to approve a pull request"),(0,o.kt)("li",{parentName:"ul"},"a dedicated GitHub App to push commits to Renovate branches"),(0,o.kt)("li",{parentName:"ul"},"a GitHub Environment for Renovate"),(0,o.kt)("li",{parentName:"ul"},"a GitHub Actions Workflows for Renovate")),(0,o.kt)("h3",{id:"support-pull-requests-from-fork-repositories"},"Support pull requests from fork repositories"),(0,o.kt)("p",null,"GitHub Actions workflows should pass even if a pull request is sent from a fork repository.\nA pull request from a fork repository can't access GitHub Secrets and ",(0,o.kt)("inlineCode",{parentName:"p"},"GITHUB_TOKEN")," has only read permissions,\nso steps requiring secrets or write permissions should be skipped or fixed."),(0,o.kt)("p",null,"Pull request from a fork repository:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"if: |\n  github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork\n")),(0,o.kt)("p",null,"Other than pull request from a fork repository:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"if: |\n  github.event_name != 'pull_request' || ! github.event.pull_request.head.repo.fork\n")))}c.isMDXComponent=!0}}]);